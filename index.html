<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gen T. De Leon National High School Tracker</title>
    
    <!-- **IMPORTANTE**: Biblioteca SheetJS para criar arquivos .xlsx -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --white-color: #ffffff;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: #f8f9fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        header {
            background-color: var(--secondary-color);
            color: var(--white-color);
            padding: 2rem 0;
            text-align: center;
            border-bottom: 5px solid var(--primary-color);
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .logo span {
            color: var(--primary-color);
        }

        .card {
            background: var(--white-color);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            padding: 2rem;
            margin-top: 2rem;
        }

        .card-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .card-header h2 {
            font-size: 1.8rem;
            color: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
        }

        .btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-excel {
            background-color: #1D6F42;
            margin-top: 1rem;
        }

        .btn-excel:hover {
            background-color: #165933;
        }

        .user-role-options {
            display: flex;
            gap: 1rem;
        }

        .role-option input[type="radio"] {
            display: none;
        }

        .role-option label {
            display: block;
            padding: 1rem;
            background-color: var(--light-color);
            border: 2px solid var(--light-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-option input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: var(--white-color);
            border-color: var(--primary-color);
        }

        .additional-fields {
            display: none;
            animation: fadeIn 0.5s;
        }

        .status-indicator {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-early { background-color: rgba(39, 174, 96, 0.1); color: var(--success-color); }
        .status-late { background-color: rgba(231, 76, 60, 0.1); color: var(--danger-color); }
        .status-ontime { background-color: rgba(52, 152, 219, 0.1); color: var(--primary-color); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        footer {
            text-align: center;
            padding: 2rem 0;
            margin-top: 3rem;
            background-color: var(--dark-color);
            color: var(--light-color);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Gen T. De Leon NHS <span>Tracker</span></div>
        <p>Attendance Management System</p>
    </header>
    
    <main class="container">
        <div class="card">
            <div class="card-header">
                <h2>Mark Attendance</h2>
            </div>
            <form id="attendanceForm">
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Select Your Role</label>
                    <div class="user-role-options">
                        <div class="role-option">
                            <input type="radio" id="student" name="userRole" value="student" checked>
                            <label for="student">Student</label>
                        </div>
                        <div class="role-option">
                            <input type="radio" id="teacher" name="userRole" value="teacher">
                            <label for="teacher">Teacher</label>
                        </div>
                    </div>
                </div>
                
                <div id="student-specific-fields">
                    <div class="form-group">
                        <label for="studentId">Student ID</label>
                        <input type="text" id="studentId" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="gradeLevel">Grade Level</label>
                        <select id="gradeLevel" class="form-control">
                            <option value="">Select Grade</option>
                            <optgroup label="Morning (6:20AM-12:30NN)">
                                <option value="7">Grade 7</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                            </optgroup>
                            <optgroup label="Afternoon (12:45NN-7:30PM)">
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="12">Grade 12</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <div id="teacher-specific-fields" class="additional-fields">
                     <div class="form-group">
                        <label for="teacherId">Teacher ID</label>
                        <input type="text" id="teacherId" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="department">Department</label>
                        <select id="department" class="form-control">
                            <option value="">Select Department</option>
                            <optgroup label="JHS Departments">
                                <option value="Filipino">Filipino</option>
                                <option value="MAPEH">MAPEH</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="ESP">ESP</option>
                                <option value="AP">AP</option>
                                <option value="TLE">TLE</option>
                                <option value="English">English</option>
                                <option value="Science">Science</option>
                            </optgroup>
                             <optgroup label="Faculty Offices">
                                <option value="Faculty A (Building B)">Faculty A (Building B)</option>
                                <option value="Faculty B (Building B)">Faculty B (Building B)</option>
                            </optgroup>
                            <optgroup label="Admin Offices">
                                <option value="Principal's Office (Building A)">Principal's Office (Building A)</option>
                                <option value="Assistant Principal's Office">Assistant Principal's Office</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="timeIn">Time In <span id="timeInStatus" class="status-indicator" style="display: none;"></span></label>
                    <input type="time" id="timeIn" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="timeOut">Time Out</label>
                    <input type="time" id="timeOut" class="form-control">
                </div>
                
                <button type="submit" class="btn btn-block">Submit</button>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Export Records</h2>
            </div>
            <div class="form-group">
                <button type="button" id="exportStudentRecords" class="btn btn-excel btn-block">Export Student Records</button>
                <button type="button" id="exportTeacherRecords" class="btn btn-excel btn-block">Export Teacher Records</button>
            </div>
        </div>
    </main>
    
    <footer>
        <p>&copy; 2025 Gen T. De Leon National High School Tracker. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const form = document.getElementById('attendanceForm');
            const roleRadios = document.querySelectorAll('input[name="userRole"]');
            const studentFields = document.getElementById('student-specific-fields');
            const teacherFields = document.getElementById('teacher-specific-fields');
            const gradeSelect = document.getElementById('gradeLevel');
            const timeInField = document.getElementById('timeIn');
            const timeInStatus = document.getElementById('timeInStatus');

            // App State
            let attendanceRecords = [];
            const isFriday = new Date().getDay() === 5;

            // Schedules
            const schedules = {
                student: {
                    '7': { start: '06:20', end: '12:30' },
                    '10': { start: '06:20', end: '12:30' },
                    '11': { start: '06:20', end: '12:30' },
                    '8': { start: '12:45', end: isFriday ? '18:45' : '19:30' },
                    '9': { start: '12:45', end: isFriday ? '18:45' : '19:30' },
                    '12': { start: '12:45', end: isFriday ? '18:45' : '19:30' },
                },
                teacher: { start: '08:00', end: '17:00' }
            };

            const getPunctuality = (timeIn, schedule) => {
                if (!timeIn || !schedule) return { text: '', class: '' };
                
                const timeInDate = new Date(`1970-01-01T${timeIn}:00`);
                const scheduleStartDate = new Date(`1970-01-01T${schedule.start}:00`);

                // Early: Se o horário de entrada for anterior ao horário de início agendado
                if (timeInDate < scheduleStartDate) {
                    return { text: 'Early', class: 'status-early' };
                }
                
                // Late: Se o horário de entrada for 1 minuto (60000 ms) ou mais após o início agendado
                if (timeInDate.getTime() >= scheduleStartDate.getTime() + 60000) {
                    return { text: 'Late', class: 'status-late' };
                }
                
                // On Time: Se não for adiantado nem atrasado
                return { text: 'On Time', class: 'status-ontime' };
            };

            const updateTimeInStatus = () => {
                const role = document.querySelector('input[name="userRole"]:checked').value;
                const timeIn = timeInField.value;
                let schedule;

                if (role === 'student') {
                    const grade = gradeSelect.value;
                    schedule = schedules.student[grade];
                } else {
                    schedule = schedules.teacher;
                }
                
                const punctuality = getPunctuality(timeIn, schedule);

                if (punctuality.text) {
                    timeInStatus.textContent = punctuality.text;
                    timeInStatus.className = `status-indicator ${punctuality.class}`;
                    timeInStatus.style.display = 'inline-block';
                } else {
                    timeInStatus.style.display = 'none';
                }
            };

            const toggleRoleFields = () => {
                const selectedRole = document.querySelector('input[name="userRole"]:checked').value;
                studentFields.style.display = selectedRole === 'student' ? 'block' : 'none';
                teacherFields.style.display = selectedRole === 'teacher' ? 'block' : 'none';
                teacherFields.classList.toggle('additional-fields', selectedRole !== 'teacher');
                updateTimeInStatus();
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const fullName = document.getElementById('fullName').value;
                const role = document.querySelector('input[name="userRole"]:checked').value;
                const timeIn = document.getElementById('timeIn').value;
                const timeOut = document.getElementById('timeOut').value;

                let schedule, id, details;

                if (role === 'student') {
                    const grade = gradeSelect.value;
                    if (!grade) {
                        alert('Please select a grade level.');
                        return;
                    }
                    schedule = schedules.student[grade];
                    id = document.getElementById('studentId').value;
                    details = `Grade ${grade}`;
                } else { // Teacher
                    schedule = schedules.teacher;
                    id = document.getElementById('teacherId').value;
                    details = document.getElementById('department').value;
                     if (!details) {
                        alert('Please select a department.');
                        return;
                    }
                }

                const punctuality = getPunctuality(timeIn, schedule);

                const record = {
                    name: fullName,
                    role: role.charAt(0).toUpperCase() + role.slice(1),
                    id,
                    details,
                    timeIn,
                    timeOut,
                    status: punctuality.text,
                    timestamp: new Date().toISOString()
                };
                
                attendanceRecords.push(record);
                alert(`Attendance for ${record.name} recorded successfully! Status: ${record.status}`);
                form.reset();
                toggleRoleFields();
                updateTimeInStatus();
            });

            const exportToExcel = (role) => {
                const roleName = role.charAt(0).toUpperCase() + role.slice(1);
                const recordsForRole = attendanceRecords.filter(r => r.role.toLowerCase() === role);
                
                if (recordsForRole.length === 0) {
                    alert(`No records found for ${roleName}s.`);
                    return;
                }

                // 1. Preparar dados para a planilha de Log In
                const loginHeaders = ["Name", "ID", role === 'student' ? "Grade Level" : "Department", "Time In", "Punctuality", "Date"];
                const loginData = recordsForRole
                    .filter(r => r.timeIn) // Apenas registros com Time In
                    .map(r => [
                        r.name,
                        r.id,
                        r.details,
                        r.timeIn,
                        r.status,
                        new Date(r.timestamp).toLocaleDateString()
                    ]);
                
                // 2. Preparar dados para a planilha de Log Out
                const logoutHeaders = ["Name", "ID", role === 'student' ? "Grade Level" : "Department", "Time Out", "Date"];
                const logoutData = recordsForRole
                    .filter(r => r.timeOut) // Apenas registros com Time Out
                    .map(r => [
                        r.name,
                        r.id,
                        r.details,
                        r.timeOut,
                        new Date(r.timestamp).toLocaleDateString()
                    ]);

                // 3. Criar o Workbook e as Worksheets usando SheetJS
                const wb = XLSX.utils.book_new();
                
                const loginSheet = XLSX.utils.aoa_to_sheet([loginHeaders, ...loginData]);
                const logoutSheet = XLSX.utils.aoa_to_sheet([logoutHeaders, ...logoutData]);

                // 4. Adicionar as planilhas ao Workbook
                XLSX.utils.book_append_sheet(wb, loginSheet, "Log Ins");
                XLSX.utils.book_append_sheet(wb, logoutSheet, "Log Outs");
                
                // 5. Gerar o arquivo e acionar o download
                XLSX.writeFile(wb, `${roleName}_Records.xlsx`);
            };

            // Event Listeners
            roleRadios.forEach(radio => radio.addEventListener('change', toggleRoleFields));
            timeInField.addEventListener('input', updateTimeInStatus);
            gradeSelect.addEventListener('change', updateTimeInStatus);
            
            document.getElementById('exportStudentRecords').addEventListener('click', () => exportToExcel('student'));
            document.getElementById('exportTeacherRecords').addEventListener('click', () => exportToExcel('teacher'));

            // Initial setup
            toggleRoleFields();
        });
    </script>
</body>
</html>
